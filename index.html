<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å„¿ç«¥è¯†å­—å°æŠ¥ç”Ÿæˆå™¨</title>
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <div class="container">
        <header>
            <h1>å„¿ç«¥è¯†å­—å°æŠ¥ç”Ÿæˆå™¨</h1>
            <p class="subtitle">ä¸º 5-9 å²å„¿ç«¥ç”ŸæˆåŒè¯­è¯†å­—å°æŠ¥</p>
        </header>

        <!-- API é…ç½®ï¼ˆå¯æŠ˜å ï¼‰ -->
        <section class="section api-section-collapsible">
            <h2 onclick="toggleApiSection()">ğŸ”§ API é…ç½® <span id="api-toggle-icon">â–¼</span></h2>
            <div id="api-config-content">
                <div class="api-config-container">
                    <!-- NanoBanana API -->
                    <div class="api-group">
                        <h3>ğŸ“· NanoBanana APIï¼ˆå›¾ç‰‡ç”Ÿæˆï¼‰</h3>
                        <div class="form-group">
                            <label>API Key <span class="required">*</span></label>
                            <input type="password" id="nanobanana-key" placeholder="è¯·è¾“å…¥ NanoBanana API Key">
                        </div>
                    </div>

                    <!-- æ–‡æœ¬ç”Ÿæˆ API -->
                    <div class="api-group">
                        <h3>ğŸ’¬ æ–‡æœ¬ç”Ÿæˆ APIï¼ˆè¯æ±‡ç”Ÿæˆ/ç¿»è¯‘ï¼‰</h3>
                        <div class="form-group">
                            <label>æ¥å£åœ°å€ <span class="required">*</span></label>
                            <input type="text" id="text-api-url" value="https://api.siliconflow.cn/v1/chat/completions">
                            <small>æ”¯æŒ OpenAI å…¼å®¹æ ¼å¼çš„ API</small>
                        </div>
                        <div class="form-group">
                            <label>API Key <span class="required">*</span></label>
                            <input type="password" id="text-api-key" placeholder="è¯·è¾“å…¥æ–‡æœ¬ API Key">
                        </div>
                        <div class="form-group">
                            <label>æ¨¡å‹åç§° <span class="required">*</span></label>
                            <input type="text" id="text-api-model" value="Pro/deepseek-ai/DeepSeek-V3.2">
                        </div>
                    </div>
                </div>

                <div class="button-group">
                    <button id="save-api-btn" class="btn btn-secondary">ä¿å­˜é…ç½®</button>
                    <button id="clear-api-btn" class="btn btn-secondary">æ¸…é™¤é…ç½®</button>
                </div>
            </div>
        </section>

        <!-- ä¸»åº”ç”¨åŒºåŸŸï¼ˆé»˜è®¤å±•å¼€ï¼‰-->
        <div id="main-app">
            <!-- åœºæ™¯é€‰æ‹© -->
            <section class="section">
                <h2>1ï¸âƒ£ é€‰æ‹©æˆ–è¾“å…¥åœºæ™¯</h2>
                <div class="scene-selection">
                    <div class="preset-scenes">
                        <button class="scene-btn" data-scene="è¶…å¸‚">ğŸ›’ è¶…å¸‚</button>
                        <button class="scene-btn" data-scene="åŒ»é™¢">ğŸ¥ åŒ»é™¢</button>
                        <button class="scene-btn" data-scene="å…¬å›­">ğŸŒ³ å…¬å›­</button>
                        <button class="scene-btn" data-scene="åŠ¨ç‰©å›­">ğŸ¦ åŠ¨ç‰©å›­</button>
                        <button class="scene-btn" data-scene="å­¦æ ¡">ğŸ« å­¦æ ¡</button>
                    </div>
                    <div class="custom-scene">
                        <label>æˆ–è‡ªå®šä¹‰åœºæ™¯ï¼š</label>
                        <input type="text" id="custom-scene-input" placeholder="å¦‚ï¼šæ¸¸ä¹åœºã€å›¾ä¹¦é¦†">
                        <button id="confirm-custom-scene-btn" class="btn btn-small">ç¡®å®š</button>
                    </div>
                    <div id="selected-scene" class="selected-info"></div>
                </div>
            </section>

            <!-- æ ‡é¢˜è¾“å…¥ -->
            <section class="section">
                <h2>2ï¸âƒ£ è¾“å…¥å°æŠ¥æ ‡é¢˜</h2>
                <input type="text" id="title-input" class="title-input" placeholder='å¦‚ï¼šã€Šæˆ‘çš„è¶…å¸‚ä¹‹æ—…ã€‹'>
            </section>

            <div class="button-group">
                <button id="generate-vocab-btn" class="btn btn-primary" disabled>ç”Ÿæˆè¯æ±‡é¢„è§ˆ</button>
            </div>

            <!-- è¯æ±‡åˆ—è¡¨ï¼ˆåˆå§‹éšè—ï¼‰-->
            <section id="vocab-section" class="section" style="display: none;">
                <h2>3ï¸âƒ£ è¯æ±‡åˆ—è¡¨ï¼ˆå¯ç¼–è¾‘ï¼‰</h2>
                <div id="vocab-container">
                    <!-- æ ¸å¿ƒè¯æ±‡ -->
                    <div class="vocab-category">
                        <h3>æ ¸å¿ƒè§’è‰²ä¸è®¾æ–½ï¼ˆ3-5ä¸ªï¼‰</h3>
                        <ul id="vocab-core" class="vocab-list"></ul>
                        <button class="add-word-btn" data-category="æ ¸å¿ƒ">+ æ·»åŠ è¯æ±‡</button>
                    </div>

                    <!-- ç‰©å“è¯æ±‡ -->
                    <div class="vocab-category">
                        <h3>å¸¸è§ç‰©å“/å·¥å…·ï¼ˆ5-8ä¸ªï¼‰</h3>
                        <ul id="vocab-items" class="vocab-list"></ul>
                        <button class="add-word-btn" data-category="ç‰©å“">+ æ·»åŠ è¯æ±‡</button>
                    </div>

                    <!-- ç¯å¢ƒè¯æ±‡ -->
                    <div class="vocab-category">
                        <h3>ç¯å¢ƒä¸è£…é¥°ï¼ˆ3-5ä¸ªï¼‰</h3>
                        <ul id="vocab-environment" class="vocab-list"></ul>
                        <button class="add-word-btn" data-category="ç¯å¢ƒ">+ æ·»åŠ è¯æ±‡</button>
                    </div>
                </div>

                <div class="button-group">
                    <button id="test-simple-image-btn" class="btn btn-secondary" onclick="testSimpleImage()">ğŸ æµ‹è¯•ç®€å•å›¾ç‰‡</button>
                    <button id="generate-image-btn" class="btn btn-primary btn-large">ğŸ¨ ç”Ÿæˆå›¾ç‰‡</button>
                </div>
            </section>

            <!-- ç”Ÿæˆç»“æœï¼ˆåˆå§‹éšè—ï¼‰-->
            <section id="result-section" class="section" style="display: none;">
                <h2>4ï¸âƒ£ ç”Ÿæˆç»“æœ</h2>
                <div id="loading-container" class="loading-container">
                    <div class="spinner"></div>
                    <p id="loading-text">æ­£åœ¨ç”Ÿæˆå›¾ç‰‡ï¼Œè¯·ç¨å€™...</p>
                    <p id="loading-hint">é¢„è®¡éœ€è¦ 2-5 åˆ†é’Ÿï¼ˆå¼‚æ­¥ä»»åŠ¡æ¨¡å¼ï¼‰</p>
                </div>
                <div id="result-container" class="result-container" style="display: none;">
                    <img id="result-image" alt="ç”Ÿæˆçš„è¯†å­—å°æŠ¥">
                    <div class="button-group">
                        <button id="download-btn" class="btn btn-primary">ä¸‹è½½å›¾ç‰‡</button>
                        <button id="regenerate-btn" class="btn btn-secondary">é‡æ–°ç”Ÿæˆ</button>
                        <button id="new-generation-btn" class="btn btn-secondary">ç”Ÿæˆæ–°çš„</button>
                    </div>
                </div>
            </section>
        </div>
    </div>

    <!-- æ·»åŠ è¯æ±‡æ¨¡æ€æ¡† -->
    <div id="add-word-modal" class="modal" style="display: none;">
        <div class="modal-content">
            <h3>æ·»åŠ æ–°è¯æ±‡</h3>
            <div class="form-group">
                <label>ç±»åˆ«</label>
                <p id="modal-category-name"></p>
            </div>
            <div class="form-group">
                <label>è¾“å…¥æ±‰å­— <span class="required">*</span></label>
                <input type="text" id="modal-word-input" placeholder="å¦‚ï¼šè‹¹æœ">
                <small>AI å°†è‡ªåŠ¨ç¿»è¯‘æˆè‹±æ–‡</small>
            </div>
            <div class="button-group">
                <button id="modal-cancel-btn" class="btn btn-secondary">å–æ¶ˆ</button>
                <button id="modal-add-btn" class="btn btn-primary">æ·»åŠ </button>
            </div>
            <div id="modal-loading" class="modal-loading" style="display: none;">
                <div class="spinner small"></div>
                <span>æ­£åœ¨ç¿»è¯‘...</span>
            </div>
        </div>
    </div>

    <!-- JavaScript æ–‡ä»¶ -->
    <script src="js/vocabulary.js"></script>
    <script src="js/api-new.js"></script>
    <script src="js/prompt.js"></script>
    <script src="js/app.js"></script>

    <script>
        // åˆ‡æ¢ API é…ç½®åŒºåŸŸæ˜¾ç¤º/éšè—
        function toggleApiSection() {
            const section = document.querySelector('.api-section-collapsible');
            const icon = document.getElementById('api-toggle-icon');

            if (section.classList.contains('api-section-collapsed')) {
                section.classList.remove('api-section-collapsed');
                icon.textContent = 'â–¼';
                document.getElementById('api-config-content').style.display = 'block';
            } else {
                section.classList.add('api-section-collapsed');
                icon.textContent = 'â–¶';
                document.getElementById('api-config-content').style.display = 'none';
            }
        }

        // é¡µé¢åŠ è½½æ—¶ï¼Œé»˜è®¤æŠ˜å  API é…ç½®
        document.addEventListener('DOMContentLoaded', () => {
            setTimeout(() => {
                toggleApiSection();
            }, 500);
        });

        // æµ‹è¯•ç®€å•å›¾ç‰‡ç”Ÿæˆ
        async function testSimpleImage() {
            // ä½¿ç”¨å…¨å±€çš„åº”ç”¨å®ä¾‹
            let app = window.storybookApp;

            // å¦‚æœæ²¡æœ‰å…¨å±€å®ä¾‹ï¼Œåˆ›å»ºä¸€ä¸ªå¹¶ç¡®ä¿åŠ è½½é…ç½®
            if (!app) {
                app = new StorybookApp();
                window.storybookApp = app;

                // ç¡®ä¿åŠ è½½äº† API é…ç½®
                if (app.apiConfig && app.apiConfig.isValid()) {
                    const config = app.apiConfig.load();
                    console.log('åŠ è½½çš„ API é…ç½®:', {
                        hasNanoBananaKey: !!config.nanoBananaKey,
                        nanoBananaKeyLength: config.nanoBananaKey ? config.nanoBananaKey.length : 0
                    });
                } else {
                    alert('è¯·å…ˆé…ç½® API Keyï¼');
                    return;
                }
            }

            // æ˜¾ç¤ºç»“æœåŒºåŸŸå’ŒåŠ è½½çŠ¶æ€
            document.getElementById('result-section').style.display = 'block';
            document.getElementById('loading-container').style.display = 'block';
            document.getElementById('result-container').style.display = 'none';

            // æ›´æ–°åŠ è½½æ–‡æœ¬
            document.getElementById('loading-text').textContent = 'æ­£åœ¨æµ‹è¯•ç®€å•å›¾ç‰‡ç”Ÿæˆ...';

            try {
                // ä½¿ç”¨ä¸€ä¸ªéå¸¸ç®€å•çš„æç¤ºè¯
                const simplePrompt = 'ä¸€ä¸ªçº¢è‹¹æœï¼Œå¡é€šé£æ ¼ï¼Œç™½è‰²èƒŒæ™¯';
                const base64Image = await app.apiClient.generateImage(simplePrompt);

                // æ˜¾ç¤ºå›¾ç‰‡
                const imgElement = document.getElementById('result-image');
                imgElement.src = `data:image/jpeg;base64,${base64Image}`;

                // éšè—åŠ è½½çŠ¶æ€ï¼Œæ˜¾ç¤ºç»“æœ
                document.getElementById('loading-container').style.display = 'none';
                document.getElementById('result-container').style.display = 'block';
            } catch (error) {
                alert('æµ‹è¯•ç®€å•å›¾ç‰‡å¤±è´¥ï¼š' + error.message);
                document.getElementById('result-section').style.display = 'none';
            }
        }
    </script>
</body>
</html>
